<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="eventing_statistics">
  
  <title>
    Statistics
  </title>
  
  <shortdesc>
    Eventing statistics can be fetched from each Eventing node, using the REST API.
  </shortdesc>
  
  <body>
    
    <section>
      
      <title>
        Deploy
      </title>
      
      <p>
        Eventing statistics can be fetched from each Eventing node using the REST API bound to localhost. The resulting 
        statistics are local to the node, and suitable for further aggregation across nodes of the cluster. The following
        endpoint could be used to get the statistics:
      </p>
      
      <codeblock outputclass="language-bourne">curl http://user:pass@localhost:8096/api/v1/stats?type=full</codeblock>
      
      <p>
        This will return statistics regarding events processing, events remaining, execution, failure, latency, 
        worker PIDs, and seqs processed. This is shown below:
      </p>
      
      <codeblock outputclass="language-javascript">[{
      "function_name": "stock-tracker",
      "event_processing_stats": {
            "DCP_DELETION": 14,
            "DCP_MUTATION": 1,
            "DCP_SNAPSHOT": 15,
            "DCP_STREAMREQ": 1024,
            "DOC_TIMER_EVENTS": 121,
            "CRON_TIMER_EVENTS": 231,
            "TIMERS_IN_PAST": 4
      },
      "events_remaining": {
            "dcp_backlog": 33
      },
      "execution_stats": {
            "agg_queue_size": 2,
            "cron_timer_msg_counter": 0,
            "dcp_delete_msg_counter": 14,
            "dcp_mutation_msg_counter": 1,
            "doc_timer_create_failure": 0,
            "doc_timer_msg_counter": 0,
            "messages_parsed": 67,
            "on_delete_failure": 0,
            "on_delete_success": 14,
            "on_update_failure": 0,
            "on_update_success": 1
      },
      "failure_stats": {
            "bucket_op_exception_count": 0,
            "checkpoint_failure_count": 66,
            "n1ql_op_exception_count": 0,
            "timeout_count": 0
      },
      "latency_stats": {
            "100": 12,
            "1000": 3
      },
      "worker_pids": {
            "worker_h1_0": 28558,
            "worker_h1_1": 28559,
            "worker_h1_2": 28560
      },
      "lcb_exception_stats": {
            "13": 200
      },
      "planner_stats": [{
                  "host_name": "127.0.0.1:9301",
                  "start_vb": 0,
                  "vb_count": 512
            },
            {
                  "host_name": "192.168.0.14:9300",
                  "start_vb": 512,
                  "vb_count": 512
            }
      ],
      "vb_distribution_stats": {
            "127.0.0.1:9300": {
                  "worker_h1_2": "[854-1023]"
            },
            "127.0.0.1:9301": {
                  "worker_h1_0": "[0-170]",
                  "worker_h1_1": "[171-341]",
                  "worker_h1_2": "[342-511]"
            },
            "192.168.0.14:9300": {
                  "worker_h1_0": "[512-682]",
                  "worker_h1_1": "[683-853]"
            }
      },
      "dcp_event_backlog_per_vb": {
            "0": 1,
            ...
      },
      "doc_timer_debug_stats": {
            "0": {},
            ...
      },
      "plasma_stats": {
            "AllocSz": 96,
            ...
      },
      "seqs_processed": {
            "0": 0,
            "1": 0,
            ...
      }
}]
</codeblock>
      
      <p>
        Omitting the parameter `type=full` excludes `dcp_event_backlog_per_vb`, `doc_timer_debug_stats`, 
        `latency_stats`, `plasma_stats` and `seqs_processed` from the response.
      </p>
      
     </section>
    
    <section>
      
      <title>
        Execution Statistics
      </title>
      
      <p>
        Execution statistics provide insight into function execution.
      </p>
      
      <codeblock outputclass="language-bourne">curl http://user:pass@localhost:8096/getExecutionStats?name=function_name
{
  "agg_queue_size": 2,
  "cron_timer_msg_counter": 0,
  "dcp_delete_msg_counter": 5108,
  "dcp_mutation_msg_counter": 11510282,
  "doc_timer_create_failure": 0,
  "doc_timer_msg_counter": 0,
  "messages_parsed": 11803452,
  "on_delete_failure": 5108,
  "on_delete_success": 6400893,
  "on_update_failure": 0,
  "on_update_success": 11510282
}
</codeblock>
      
      <p>
        All available execution statistics are described in the table below.
      </p>
      
      <table frame="all" rowsep="1" colsep="1" id="execution_statistics">
        
        <title>
          Execution Statistics
        </title>
        
        
        <tgroup cols="4" align="left">
          <colspec colname="c1" colnum="1" colwidth="1.0*"/>
          <colspec colname="c2" colnum="2" colwidth="0.2*"/>
          <colspec colname="c3" colnum="3" colwidth="0.6*"/>
          <colspec colname="c4" colnum="4" colwidth="1.2*"/>
          <thead>
            <row>
              <entry>Name</entry>
              <entry>Type</entry>
              <entry>Field</entry>
              <entry>Description</entry>
            </row>
          </thead>
          
          <tbody>
            
            <row>
              
              <entry>
                Queue Size
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                agg_queue_size
              </entry>
              
              <entry>
                Count of events that are queued on worker processes, waiting execution.
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                Cron timer counter from eventing-consumer
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                cron_timer_msg_counter
              </entry>
              
              <entry>
                Count of Cron timer messages sent to their designated handler for execution
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                DCP Delete counter from eventing-consumer
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                dcp_delete_msg_counter
              </entry>
              
              <entry>
                Count of DCP_DELETION messages sent to their designated handler for execution
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                DCP Mutation counter from eventing-consumer
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                dcp_mutation_msg_counter
              </entry>
              
              <entry>
                Count of DCP_MUTATION messages sent to their designated handler for execution
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                Document Timer Creation Retries
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                doc_timer_create_failure
              </entry>
              
              <entry>
                Count of number of times document timers creations that were retried. Retry continues till script timeout.
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                Messages parsed counter from eventing-consumer
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                messages_parsed
              </entry>
              
              <entry>
                Count of flatbuffer encoded messages decoded/parsed by eventing-consumer.
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                OnDelete handler failures
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                on_delete_failure
              </entry>
              
              <entry>
                Count of number of delete handler executions that terminated with an uncaught exception.
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                OnUpdate handler failures
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                
                on_update_failure
                
              </entry>
              
              <entry>
                Count of number of update handler executions that terminated with an uncaught exception.
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                OnDelete handler successful invocations
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                on_delete_success
              </entry>
              
              <entry>
                Counter for number of times OnDelete handler was executed successfully.
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                OnUpdate handler successful invocations
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                on_update_success
              </entry>
              
              <entry>
                Counter for number of times OnUpdate handler was executed successfully.
              </entry>
              
            </row>
            
          </tbody>
        </tgroup>
      </table>
      
    </section>
    
    <section>
      
      <title>
        Latency Statistics
      </title>
      
      <p>
        These give the latency of handler-executions in wall-clock time, in aggregate, across all handlers and 
        timers. The returned object has a key that is the latency range in microseconds, and a value that is 
        the count of executions in this range.
      </p>
      
      <codeblock outputclass="language-bourne">curl http://user:pass@localhost:8096/getLatencyStats?name=function_name
{
  "1000": 17355495,
  "10000": 2959,
  "100000": 23,
  "101000": 20,
  "102000": 14,
  "103000": 11,
  "104000": 15,
  "105000": 13,
  "106000": 8,
  "107000": 13,
  "108000": 12,
  "109000": 14,
  "11000": 2077,
}
</codeblock>
      
    </section>
    
    <section>
      
      <title>
        DCP Statistics
      </title>
      
      <p>
        This endpoint returns backlog of events that have occured but are not yet processed by event handlers.
      </p>
      
<codeblock outputclass="language-bourne">curl http://user:pass@localhost:8096/getDcpEventsRemaining?name=function_name
{
  "dcp_backlog": 4808
}</codeblock>
      
    </section>
    
    <section>
      
      <title>
        Failure Statistics
      </title>
      
      <p>
        This group of counters provides an insight into failures encountered during function execution.
      </p>
      
      <codeblock outputclass="language-bourne">curl http://user:password@localhost:8096/getFailureStats?name=function_name
{
  "bucket_op_exception_count": 5108,
  "checkpoint_failure_count": 0,
  "n1ql_op_exception_count": 0,
  "timeout_count": 0
}
</codeblock>
      
      <p>
        All available failure statistics are provided in the table below.
      </p>
      
      <table frame="all" rowsep="1" colsep="1" id="failure_statistics">
        
        <title>
          Failure Statistics
        </title>
        
        
        <tgroup cols="4" align="left">
          <colspec colname="c1" colnum="1" colwidth="1.0*"/>
          <colspec colname="c2" colnum="2" colwidth="0.2*"/>
          <colspec colname="c3" colnum="3" colwidth="0.6*"/>
          <colspec colname="c4" colnum="4" colwidth="1.2*"/>
          <thead>
            <row>
              <entry>Name</entry>
              <entry>Type</entry>
              <entry>Field</entry>
              <entry>Description</entry>
            </row>
          </thead>
          
          <tbody>
            
            <row>
              
              <entry>
                Timeout Count
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                timeout_count
              </entry>
              
              <entry>
                Count of number of handler executions that were terminated because the handler ran 
                longer than the configured script timeout.
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                N1QL Operation Failure Count
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                n1ql_op_exception_count
              </entry>
              
              <entry>
                Count of failures encountered when running N1QL queries. Each such failure would result 
                in an exception thrown in JS handler.
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                Bucket Operation Failure Count
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                bucket_op_exception_count
              </entry>
              
              <entry>
                Count of errors encountered during bucket operations. Each of these failures would result 
                in an exception thrown in JS handler. Integer counter.
              </entry>
              
            </row>
            
            <row>
              
              <entry>
                Checkpoint Failure Count
              </entry>
              
              <entry>
                int64
              </entry>
              
              <entry>
                checkpoint_failure_count
              </entry>
              
              <entry>
                Count of failures when checkpointing last processed sequence numbers by v8 worker. Failures 
                are retried using exponential backoff until timeout.
              </entry>
              
            </row>
            
          </tbody>
        </tgroup>
      </table>
      
    </section>
   
  </body>
</topic>
