<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE topic
  PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
  
<topic xml:lang="en-us" id="compression">
 
 <title>
  Data Compression
 </title>
 
 <shortdesc>
  Couchbase Server supports <i>data compression</i> in its communications
  with internal and external clients, and in its internal handling of documents.
 </shortdesc>
 
 <body>
  
  <section id="data-compression-overview">
   
   <title>
    Overview
   </title>
   
   <p>
    Data compression allows RAM and disk-space to be used with increased efficiency. It may
    also reduce consumption of network bandwith. Higher consumption of CPU resources may result.
   </p>
   
   <p>
    Compression, provided by the open-source library
    <xref href="http://en.wikipedia.org/wiki/Snappy_(compression)" scope="external" format="html">Snappy</xref>,
    is applied per bucket, according
    to user-specified <i>modes</i>.
    Clients elect to participate in exchanges of compressed data
    by means of a flag to the standard <codeph>HELO</codeph> network command.
   </p>
   
  </section>
  
  <section id="where-data-compression-can-be-used">
   
   <title>
    Where Data Compression is Used
   </title>
   
    <p>
     <image href="./images/compression-overview-diagram.png" id="compression-overview-diagram" align="left" width="600"/>
    </p>
   
   <p>
    Clients based on the Couchbase SDK (<b>1</b>), nodes within a cluster that participate
    in intra-cluster replication (<b>4</b>), internal Couchbase Services (<b>5</b>),
    external DCP clients (<b>6</b>), and remote clusters that participate in Cross Data-Center
    Replication (<b>7</b>) communicate their ability to send and receive compressed
    documents by using the <codeph>HELO</codeph> command, with a flag that confirms support of the <i>Snappy
    Compression</i> data type. 
   </p>
   
   <p>
    Couchbase Server may (depending on the mode of the bucket) store documents in compressed form in 
    memory (<b>2</b>). The server compresses
    documents when storing them on disk (<b>3</b>).
   </p>
   
  </section>
  
  <section id="compression-modes">
   
   <title>
    Data-Compression Modes
   </title>
   
   <p>
    Each bucket
    is configured to support one of three <i>modes</i>. After a client has communicated
    its ability to send and receive compressed data, the server's running of compression and decompression routines 
    depends on the
    mode supported by the specified bucket. The modes are:
   </p>
   
   <ul>
    <li>
     Off
    </li>
    
    <li>
     Passive
    </li>
    
    <li>
     Active
    </li>
    
   </ul>
   
   <p>
    These are described in the following sections.
   </p>
   
  </section>
  
  <section>
   
   <title>
    Data-Compression Mode: Off
   </title>
   
    <p>
     The <i>Off</i> mode provides the
     behavior of Couchbase Server 5.0 and pre-5.0. Therefore, on receipt of a compressed document,
     Couchbase Server decompresses the document when storing in memory; and recompresses it
     when storing on disk. Couchbase Server
     sends the document in uncompressed form.  
    </p>
   
    <p>
     This mode is assigned by default to buckets <i>upgraded</i> from a previous
     version of Couchbase Server.
    </p>
   
  </section>
  
  <section>
   
   <title>
    Data-Compression Mode: Passive
   </title>
   
   <p>
    On receipt of a compressed document,
    Couchbase Server stores it in compressed form both in memory
    and on disk. Couchbase Server
    sends the document back to the client in compressed form if this is supported by the client; otherwise,
    it sends the document back in uncompressed form.
   </p>
   
   <p>
    On receipt of an uncompressed document, Couchbase Server
    stores it in memory in uncompressed form, and stores in on disk in compressed form. 
    It returns the document to the client in uncompressed form.
   </p>
   
   <p>
    This mode is assigned by default to <i>new</i> buckets, in post-5.0
    versions of Couchbase Server.
   </p>
   
  </section>
  
  <section>
   
   <title>
    Data-Compression Mode: Active
   </title>
   
    <p>
     Couchbase Server actively compresses documents for storage in memory
     and on disk, even if the documents are received in uncompressed form. 
     Documents are decompressed before being sent back to those clients that do not
     support the receiving of compressed data. Documents can be sent
     in compressed form to clients that do support the receiving of compressed data, even if those
     clients originally sent the
     documents to the server in uncompressed form.
    </p>
   
  </section>
  
  <section id="switching-between-data-compression-modes">
   
   <title>
    Switching Between Data-Compression Modes
   </title>
   
   <p>
    Buckets can be switched between modes. The following behavior-changes
    should be noted:
   </p>
   
   <ul>
    
    <li>
     When a bucket formerly in Passive mode has been switched to Off mode,
     any compressed document that Couchbase Server receives for that bucket
     is stored in memory in uncompressed form. If the server
     needs to send from the bucket a document that is currently compressed, the server decompresses
     the document before sending: however, to preserve 
     memory-efficiency, the
     document remains compressed in memory.
     
     <p>
      
     </p>
     
    </li>
    
    <li>
     When a bucket has been switched from Passive to Active mode, it
     periodically runs a task that compresses uncompressed documents.
     
     <p>
      
     </p>
     
    </li>
    
    <li>
     When a bucket formerly in Active mode is switched to Off mode,
     this disables 
     the task that was periodically run to compress uncompressed documents.
     Compressed documents can continue to be received for the bucket, and are
     decompressed for storage in memory. Compressed documents within the bucket are
     decompressed before sending: however, to ensure continued 
     memory-efficiency, the
     document remains compressed in memory.
     
     <p>
      
     </p>
     
    </li>
    
   </ul>
   
  </section>
   
   
  
  <section id="enabling-compression">
   
   <title>
    Enabling Data Compression
   </title>
   
   <p>
    Couchbase Server supports data compression only when the 
    <codeph>datatype_snappy</codeph> parameter of <codeph>memcached.json</codeph>
    is set to <codeph>true</codeph> (which is the default). If this parameter
    is set to <codeph>false</codeph>, 
    new connections cannot participate in exchanges of compressed data.
   </p>
   
   <p>
    When <codeph>datatype_snappy</codeph> is <codeph>true</codeph>,
    Couchbase Server allows authorized users to configure 
    data-compression by means of the following.
   </p>
   
   <ul>
    
    <li>
     The Couchbase Web Console, the Couchbase CLI, and the Couchbase REST API,
     which allow buckets each to be assigned a
     data-compression mode; and which allow <i>Cross Data-Center Replication</i> (XDCR)
     to handle compressed documents.
     <p>
      
     </p>
    </li>
    
    
    <li>
     The <codeph>cbbackup</codeph>, <codeph>cbrestore</codeph>, and 
     associated tools, which allow
     compressed documents to be requested in the backup stream.
     <p>
      
     </p>
    </li>
    
    <li>
     The Couchbase SDK, which can elect to send and receive compressed documents.
     <p>
      
     </p>
    </li>

   </ul>
   
  </section>
  
 </body>
 
</topic>
