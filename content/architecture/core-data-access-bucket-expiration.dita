<?xml version="1.0" encoding="utf-8"?>

<!DOCTYPE topic
  PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
  
 <topic xml:lang="en-us" id="bucket-expiration">
  
  <title>
   Bucket-Data Expiration
  </title>
  
  <shortdesc>
   Bucket-data can be user-specified to expire at a given
   time. 
  </shortdesc>
  
  <body> 
   
   <section id="bucket-data-expiration-and-gdpr">
    
    <title>
     Bucket-Data Expiration and GDPR
    </title>
   
   <p>
    The European Union's <i>General Data Protection Regulation</i> (GDPR) 
    mandates the deletion of 
    EU citizens' personal data from a database, after a certain retention-period has elapsed. 
    Couchbase Server therefore allows an <i>expiration time</i> to be specified, per
    bucket: when the expiration-time is reached, all documents <i>created after
    specification of the expiration-time</i> are automatically deleted. 
    This simplifies data-expiration policy-enforcement, and reduces
    database-overhead.
   </p>
   
   <p>
    Documents created <i>before</i> specification of the expiration-time are
    <i>not</i> automatically deleted when the expiration-time is reached.
   </p>
   
   <p>
    Following automatic deletion of all documents within a bucket, the bucket is
    not itself deleted: it continues to exist, with all settings unchanged other
    than that for data-expiration, which is reset to zero &#8212; indicating 
    indefinite, continued existence for all documents subsequently created without
    individual expiration-times.
   </p>
    
    <p>
     Deleted documents and their contents no longer appear in the results of
     queries or in views.
    </p>
    
    <p>
     Note that this feature is only available in the <i>Enterprise Edition</i> of
     Couchbase Server.
    </p>
    
   </section>
   
   <section id="data-expiration-bucket-versus-document">
    
    <title>
     Data-Expiration: Bucket versus Document
    </title>
   
   <p>
    As described in the <i>Expiration Overview</i> section of
    <xref href="../sdk/core-operations.dita#devguide_kvcore_generic/expiry" scope="local" format="dita">Core Operations</xref>,
    an expiration-time can be specified <i>per document</i>,
    by means of Couchbase SDK APIs. In consequence, a document may individually bear an
    expiration-time that differs from that of the bucket. The rules that apply can 
    be demonstrated as follows:
   </p>
   
   <ol>
    
    <li>
     At point-in-time <i>T0</i>, the expiration-time for bucket <i>B</i> is specified
     as quantity-of-time <i>M</i>.
     
     <p>
      
     </p>
     
    </li>
    
    <li>
     Subsequently, at point-in-time <i>T1</i>, document <i>D0</i> is created, with no
     individual document-expiration time specified. Expiration-time for <i>D0</i> is therefore
     set to <i>T0</i> + <i>M</i>.
     
     <p>
      
     </p>
     
    </li>
    
    <li>
     Subsequently, at point-in-time <i>T2</i>, document <i>D1</i> is created, with
     an individual document-expiration time specified as quantity-of-time <i>N0</i>.
     Therefore:
     
     <p>
      
     </p>
     
     <ul>
      
      <li>
       If either <i>N0</i> = 0 (indefinite existence), 
       or (<i>T2</i> + <i>N0</i>) > (<i>T0</i> + <i>M</i>), expiration-time for <i>D1</i> is set
       as <i>T0</i> + <i>M</i>.
       
       <p>
        
       </p>
       
      </li>
      
      <li>
       Otherwise, expiration-time for <i>D1</i> is set as <i>T2</i> + <i>N0</i>.
       
       <p>
        
       </p>
       
      </li>
      
     </ul>
     
    </li>
    
    <li>
     Subsequently, at point-in-time <i>T3</i>, document <i>D1</i> is updated, with
     an individual document-expiration time specified as quantity-of-time <i>N1</i>.
     Therefore:
     
     <p>
      
     </p>
     
     <ul>
      
      <li>
       If either 
       <i>N1</i> = 0 (indefinite existence), 
       or (<i>T3</i> + <i>N1</i>) > (<i>T0</i> + <i>M</i>), expiration-time for <i>D1</i> is set
       as <i>T0</i> + <i>M</i>.
       
       <p>
        
       </p>
       
      </li>
      
      <li>
       Otherwise, expiration-time for <i>D1</i> is set as <i>T3</i> + <i>N1</i>.
       
       <p>
        
       </p>
       
      </li>
      
     </ul>
     
    </li>
    
   </ol>
   
   </section>
   
   <section id="post-expiration-purging">
    <title>
     Post-Expiration Purging
    </title>
   
     <p>
      As described in 
      <xref href="./core-data-access-bucket-disk-storage.dita" scope="local" format="dita">Bucket Disk Storage</xref>,
      after item-deletion, a <i>tombstone</i>, which includes keys and metadata, continues to be
      maintained as a record. To ensure compliance with GDPR, tombstones of documents automatically deleted by means
      of a bucket-specified expiration-time should themselves be explicitly removed by means of a <i>Metadata Purge</i>:
      this can be scheduled by means of the Couchbase Web Console, as described in
      <xref href="../settings/configure-compact-settings.dita" scope="local" format="dita">Configuring Auto-Compaction</xref>.
      Note that to ensure compliance, the interval between purges should be established as appropriately low.
     </p>
    
   </section>
   
   <section id="bucket-data-expiration-and-xdcr">
    
    <title>
     Bucket-Data Expiration and XDCR
    </title>
    
    <p>
     When a bucket is replicated by means of <i>Cross Data-Center Replication</i> (XDCR), a
     bucket expiration-time established at the origin is replicated to the target-cluster <i>only if so specified</i>
     by the user, prior to the start of XDCR. If no bucket expiration-time is replicated, documents
     replicated to the target-cluster will not be automatically deleted from it when the expiration-time is reached.
    </p>
    
    <p>
     Following replication of a bucket expiration-time to a target-cluster,
     metadata purging should be explicitly scheduled at the target-cluster; as described above, in
     <xref href="./core-data-access-bucket-expiration.dita#bucket-expiration/post-expiration-purging">Post-Expiration Purging</xref>.
    </p>
    
    <p>
     Note that when a document is replicated by XDCR, its expiration-time is communicated to the 
     target as <i>absolute</i>. This requires that
     the system-clocks of the respective clusters be fully synchronized; otherwise, inconsistent behavior may 
     result (as, for example,
     in the case where a document arrives at the target-cluster with an absolute expiration-time that is 
     earlier than the current time
     acknowledged by the target-cluster).
    </p>
    
    <p>
     For details on replicating bucket-data expiration-times with XDCR, see
     <xref href="../xdcr/xdcr-create.dita" scope="local" format="dita">Managing XDCR</xref>.
    </p>
    
   </section>
   
   <section id="setting-bucket-data-expiration">
    
    <title>
     Setting Bucket-Data Expiration
    </title>
    
    <p>
     An expiration-time can be set for bucket-data by means of any of the following:
    </p>
    
    <ul>
     
     <li>
      The APIs of the Couchbase SDK. See
      <xref href="../sdk/core-operations.dita" scope="local" format="dita">Core Operations</xref>.
      <p>
      </p>

     </li>
     
     <li>
      The UI provided by the Couchbase Web Console. See
      <xref href="../clustersetup/create-bucket.dita" scope="local" format="dita">Create a Bucket</xref>.
      <p>
      </p>
      
     </li>
     
     <li>
      The Couchbase CLI. See
      <xref href="../cli/cbcli/couchbase-cli-bucket-create.dita" scope="local" format="dita">bucket-create</xref>.
      
      <p>
      </p>
      
     </li>
     
     <li>
      The Couchbase REST API. See
      <xref href="../rest-api/rest-bucket-create.dita" scope="local" format="dita">Creating and Editing Buckets</xref>.
      <p>
      </p>
      
     </li>
     
    </ul>
    
   </section>
   
   <section id="auditing">
    
    <title>
     Auditing
    </title>
    
    <p>
     If <i>auditing</i> is switched on, changes to each bucket's expiration time are
     recorded, and can be subsequently viewed. See
     <xref href="../security/security-auditing.dita" scope="local" format="dita">Auditing</xref>.
    </p>
    
   </section>
   
  </body>
  
 </topic>