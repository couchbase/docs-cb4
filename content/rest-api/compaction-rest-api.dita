<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE reference PUBLIC "-//OASIS//DTD DITA Reference//EN" "reference.dtd">
<reference id="reference_rest_compaction">
	<title>Compaction API</title>
	<shortdesc>Compaction is used to reclaim disk space and reduce disk fragmentation.</shortdesc>
	<refbody>
		
		<section><title>Description</title>
		<p>Couchbase Server writes all data that you append, update and delete as files on disk. This can
				eventually lead to gaps in the data file, particularly when you delete data. Be
				aware the server also writes index files in a sequential format based on appending
				new results in the index. You can reclaim the empty gaps in all data files by
				performing a process called <i>compaction</i>. For both data files and index files,
				perform frequent compaction of the files on disk to help reclaim disk space and
				reduce disk fragmentation. </p>
			
			<table>
				<title>Compaction endpoints</title>
				<tgroup cols="4">
					<colspec colname="col1" colwidth="1*"/>
					<colspec colname="col2" colwidth="2*"/>
					<colspec colname="col3" colwidth="2.41*"/>
					<colspec colname="col3" colwidth="1.59*"/>
					<thead>
						<row>
							<entry>HTTP method</entry>
							<entry>URI path</entry>
							<entry>Description</entry>
							<entry>Admin Role</entry>
						</row>
					</thead>
					<tbody>
						<row>
							<entry>POST </entry>
							<entry><filepath>/pools/default/buckets/[bucket_name]/ \
									controller/compactBucket</filepath></entry>
							<entry>Compacts bucket data and indexes.</entry>
							<entry>Full, Cluster, </entry>
						</row>
						<row>
							<entry>POST</entry>
							<entry><filepath>/pools/default/buckets/[bucket_name]/ \
									controller/cancelBucketCompaction</filepath></entry>
							<entry>Cancels compaction for the specified bucket.</entry>
							<entry>Full, Cluster</entry>
						</row>
						<row>
							<entry>POST</entry>
							<entry><filepath>/[bucket_name]/_design/[ddoc_name]/ \
									_spatial/_compact</filepath></entry>
							<entry>Compacts a spatial view.</entry>
							<entry>Full, Cluster</entry>
						</row>
					</tbody>
				</tgroup>
			</table>
			
		</section>
		
		
		
		
		
		
		<section><title>Auto-compaction description</title><p>Auto-compaction parameters are configured to trigger data and view compaction. These parameters
				can be specified for an entire cluster (cluster-wide) or for a specific bucket in a cluster.</p> 
			
			<note type="note">Administrative credentials are required to change these settings.</note>			
			
			<table>
				<title>Auto-compaction endpoints</title>
					<tgroup cols="4">
					<colspec colname="col1" colwidth="1*"/>
					<colspec colname="col2" colwidth="2.54*"/>
					<colspec colname="col3" colwidth="2.02*"/>
					<colspec colname="col4" colwidth="1.31*"/>
					<thead>
						<row>
							<entry>HTTP method</entry>
							<entry>URI path</entry>
							<entry>Description</entry>
							<entry>Admin Role</entry>
						</row>
					</thead>
					<tbody>
						<row>
							<entry>POST </entry>
							<entry><filepath>/controller/setAutoCompaction</filepath></entry>
							<entry>Sets cluster-wide auto-compaction intervals and
								thresholds</entry>
							<entry>Full, Cluster</entry>
						</row>
						<row>
							<entry>GET </entry>
							<entry><filepath>/settings/autoCompaction</filepath></entry>
							<entry>Retrieves cluster-wide settings for auto-compaction</entry>
							<entry>Full, Cluster</entry>
						</row>
						<row>
							<entry>GET </entry>
							<entry><filepath>/pools/default/buckets/[bucket_name]</filepath></entry>
							<entry>Retrieves auto-compaction settings for named bucket</entry>
							<entry>Full, Cluster, Bucket*, BucketA</entry>
						</row>
						<row>
							<entry>POST</entry>
							<entry><filepath>/pools/default/buckets/[bucket_name]</filepath></entry>
							<entry>Sets auto-compaction interval or thresholds for named
								bucket</entry>
							<entry>Full, Cluster, Bucket*, BucketA</entry>
						</row>
					</tbody>
				</tgroup>
				</table>
			
			<note type="important">"Bucket A" represents a bucket administrator for a single bucket, and
				Bucket* a bucket administrator with privileges for all buckets in the cluster.</note> 
			
			
			<table>
				<title>Auto-compaction parameters</title>
					<tgroup cols="3">
						<colspec colname="col1"/>
						<colspec colname="col2"/>
						<colspec colname="col3"/>
						<thead>
							<row>
								<entry>Parameter</entry>
								<entry>Value</entry>
								<entry>Notes</entry>
							</row>
						</thead>
						<tbody>
							<row>
								<entry>databaseFragmentationThreshold: percentage</entry>
								<entry>Integer between 2 and 100</entry>
								<entry>Percentage disk fragmentation for data</entry>
							</row>
							<row>
								<entry>databaseFragmentationThreshold: size</entry>
								<entry>Integer greater than 1</entry>
								<entry>Bytes of disk fragmentation for data</entry>
							</row>
							<row>
								<entry>viewFragmentationThreshold: percentage</entry>
								<entry>Integer between 2 and 100</entry>
								<entry>Percentage disk fragmentation for index</entry>
							</row>
							<row>
								<entry>viewFragmentationThreshold: size</entry>
								<entry>Integer greater than 1</entry>
								<entry>Bytes of disk fragmentation for index</entry>
							</row>
							<row>
								<entry>parallelDBAndViewCompaction</entry>
								<entry>True or false. </entry>
								<entry>Run index and data compaction in parallel. Global setting only.</entry>
							</row>
							<row>
								<entry>allowedTimePeriod: abortOutside</entry>
								<entry>True or false</entry>
								<entry>Terminate compaction if the process takes longer than the allowed time</entry>
							</row>
							<row>
								<entry>allowedTimePeriod: fromHour</entry>
								<entry>Integer between 0 and 23</entry>
								<entry>Compaction can occur from this hour onward</entry>
							</row>
							<row>
								<entry>allowedTimePeriod: fromMinute</entry>
								<entry>Integer between 0 and 59</entry>
								<entry>Compaction can occur from this minute onward</entry>
							</row>
							<row>
								<entry>allowedTimePeriod: toHour</entry>
								<entry>Integer between 0 and 23</entry>
								<entry>Compaction can occur up to this hour</entry>
							</row>
							<row>
								<entry>allowedTimePeriod: toMinute</entry>
								<entry>Integer between 0 and 59</entry>
								<entry>Compaction can occur up to this minute</entry>
							</row>
							<row>
								<entry>purgeInterval</entry>
								<entry>Integer between 1 and 60</entry>
								<entry>Number of days a item is deleted or expired. The key and metadata for that item is
								purged by auto-compaction</entry>
							</row>
						</tbody>
					</tgroup>
				</table>
			
			<note type="note">The purge interval parameter removes the key and metadata for items that have been deleted or are expired. 
				This is known as tombstone purging.</note>
		</section>		
		<section><title>Related Information</title>
		<ul>
			<li>To learn about the storage architecture and compaction, see 
				<xref href="../understanding-couchbase/buckets-memory-and-storage/storage.dita">Storage</xref>.</li>
			<li>To update the auto-compaction settings from the Web Console, see <xref
						href="../settings/configure-compact-settings.dita"/>.</li>
			<li>To update the bucket compaction settings using the CLI, see <xref href="../cli/cbcli/couchbase-cli-bucket-compact.html" format="html"></xref>.</li>
			
		</ul>
		</section>
				
	</refbody>


</reference>
