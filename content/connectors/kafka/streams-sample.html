<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couchbase Documentation</title>
    <meta name="generator" content="Antora 1.0.0">
    <link rel="stylesheet" href="../../_/css/site.css">
  </head>
  <body class="article">
<header class="header" role="banner">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../..">Couchbase Documentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Resources</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Resource A</a>
            <a class="navbar-item" href="#">Resource B</a>
            <a class="navbar-item" href="#">Resource C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="main-wrapper">
<div class="navigation-container" data-component="kafka" data-version="3.3">
  <aside class="navigation" role="navigation">
    <div class="panels">
<div class="navigation-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="quickstart.html">Kafka</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-toggle"></button>
    <span class="nav-text">Kafka</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quickstart.html">Quickstart</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="source-configuration-options.html">Source Configuration Options</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="sink-configuration-options.html">Sink Configuration Options</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="streams-sample.html">Couchbase Sample with Kafka Streams</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="release-notes.html">Release Notes</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="navigation-explore" data-panel="explore">
  <div class="context">
    <span class="title">Kafka</span>
    <span class="version">3.3</span>
  </div>
  <ul class="components">
    <li class="component">
      <span class="title">Couchbase Lite</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../couchbase-lite/2.1/index.html">2.1</a>
        </li>
        <li class="version">
          <a href="../../couchbase-lite/2.0/index.html">2.0</a>
        </li>
        <li class="version">
          <a href="../../couchbase-lite/1.4/index.html">1.4</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <span class="title">Kafka</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="quickstart.html">3.3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <span class="title">Sync Gateway</span>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../sync-gateway/2.1/index.html">2.1</a>
        </li>
        <li class="version">
          <a href="../../sync-gateway/2.0/index.html">2.0</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
  <main class="main" role="main">
<div class="toolbar" role="navigation">
  <button class="navigation-toggle"></button>
<nav class="crumbs" role="navigation" aria-label="breadcrumbs">
  <ul>
    <li class="crumb">Kafka</li>
    <li class="crumb"><a href="streams-sample.html">Couchbase Sample with Kafka Streams</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="file:///Users/jamesnocentini/Developer/docs-site/kafka-connect-couchbase/docs/modules/ROOT/pages/streams-sample.adoc">Edit this Page</a></div>
</div>
    <div class="body">
      <style>
        .doc h1 > a.anchor,
        .doc h2 > a.anchor,
        .doc h3 > a.anchor,
        .doc h4 > a.anchor,
        .doc h5 > a.anchor,
        .doc h6 > a.anchor {
          position: absolute;
          text-decoration: none;
          width: 1.75ex;
          margin-left: -1.5ex;
          visibility: hidden;
          font-size: 0.8em;
        }
        .doc h1 > a.anchor::before,
        .doc h2 > a.anchor::before,
        .doc h3 > a.anchor::before,
        .doc h4 > a.anchor::before,
        .doc h5 > a.anchor::before,
        .doc h6 > a.anchor::before {
          content: "\00a7";
        }
        .doc h1:hover > a.anchor,
        .doc h2:hover > a.anchor,
        .doc h3:hover > a.anchor,
        .doc h4:hover > a.anchor,
        .doc h5:hover > a.anchor,
        .doc h6:hover > a.anchor {
          visibility: visible;
        }
      </style>
      <article class="doc">
<div class="paragraph">
<p>Sample application which uses Couchbase connector with Kafka Streams.</p>
</div>
<div class="sect1">
<h2 id="prerequisites"><a class="anchor" href="#prerequisites"></a>Prerequisites</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This example demonstrates how to build a data pipeline using Kafka to
move data from Couchbase Server to a MySQL database. It assumes a
Couchbase Server instance with the <code>beer-sample</code> bucket deployed on
localhost and a MySQL server accessible on its default port (<code>3306</code>).
MySQL should also have a <code>beer_sample_sql</code> database. The following
snippet describes the schema of the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-text hljs" data-lang="text">DROP DATABASE IF EXISTS beer_sample_sql;
CREATE DATABASE beer_sample_sql CHARACTER SET utf8 COLLATE utf8_general_ci;
USE beer_sample_sql;
CREATE TABLE breweries (
   id VARCHAR(256) NOT NULL,
   name VARCHAR(256),
   description TEXT,
   country VARCHAR(256),
   city VARCHAR(256),
   state VARCHAR(256),
   phone VARCHAR(40),
   updated_at DATETIME,
   PRIMARY KEY (id)
);
CREATE TABLE beers (
   id VARCHAR(256) NOT NULL,
   brewery_id VARCHAR(256) NOT NULL,
   name VARCHAR(256),
   category VARCHAR(256),
   style VARCHAR(256),
   description TEXT,
   abv DECIMAL(10,2),
   ibu DECIMAL(10,2),
   updated_at DATETIME,
   PRIMARY KEY (id)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example is built on top of the
<a href="http://docs.confluent.io/3.1.1/installation.html">Confluent Platform</a>
which also installed on localhost, along with the Couchbase connector.
We will use the Confluent
<a href="http://docs.confluent.io/3.1.1/control-center/docs/index.html">Control
Center</a> to configure the link, so make sure this service also is
running. The commands below can be used to start all dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ service couchbase-server start
$ service mysql-server start

# For RPM/DEB based Confluent Platform deployments the paths might be absolute.
$ ./bin/zookeeper-server-start ./etc/kafka/zookeeper.properties &amp;
$ ./bin/kafka-server-start ./etc/kafka/server.properties &amp;
$ ./bin/schema-registry-start ./etc/schema-registry/schema-registry.properties &amp;

# Run connect framework in distributed mode
$ ./bin/connect-distributed $CONNECTOR_DIST/config/connect-distributed.properties

$ ./bin/control-center-start etc/confluent-control-center/control-center.properties</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that for the <code>connect-distributed</code> script we use the configuration
from the couchbase connector. You can use a stock configuration too, but
make sure that it will use Avro convertors and configure interceptors
for monitoring:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">key.converter=io.confluent.connect.avro.AvroConverter
key.converter.schema.registry.url=http://localhost:8081
value.converter=io.confluent.connect.avro.AvroConverter
value.converter.schema.registry.url=http://localhost:8081
consumer.interceptor.classes=io.confluent.monitoring.clients.interceptor.MonitoringConsumerInterceptor
producer.interceptor.classes=io.confluent.monitoring.clients.interceptor.MonitoringProducerInterceptor</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="code-overview"><a class="anchor" href="#code-overview"></a>Code Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The full code of this sample is accessible in the connector repository
at
<a href="https://github.com/couchbase/kafka-connect-couchbase/blob/master/src/test/java/examples/KafkaStreamsDemo.java">src/test/java/examples/KafkaStreamsDemo.java</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">try {
    Class.forName("com.mysql.jdbc.Driver");
} catch (ClassNotFoundException e) {
    System.err.println("Failed to load MySQL JDBC driver");
}
Connection connection = DriverManager
        .getConnection("jdbc:mysql://localhost:3306/beer_sample_sql", "root", "secret");
final PreparedStatement insertBrewery = connection.prepareStatement(
        "INSERT INTO breweries (id, name, description, country, city, state, phone, updated_at)" +
                " VALUES (?, ?, ?, ?, ?, ?, ?, ?)" +
                " ON DUPLICATE KEY UPDATE" +
                " name=VALUES(name), description=VALUES(description), country=VALUES(country)," +
                " country=VALUES(country), city=VALUES(city), state=VALUES(state)," +
                " phone=VALUES(phone), updated_at=VALUES(updated_at)");
final PreparedStatement insertBeer = connection.prepareStatement(
        "INSERT INTO beers (id, brewery_id, name, description, category, style, abv, ibu, updated_at)" +
                " VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)" +
                " ON DUPLICATE KEY UPDATE" +
                " brewery_id=VALUES(brewery_id), name=VALUES(name), description=VALUES(description)," +
                " category=VALUES(category), style=VALUES(style), abv=VALUES(abv)," +
                " ibu=VALUES(ibu), updated_at=VALUES(updated_at)");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>main</code> function of the <code>KafkaStreamsDemo</code> class starts with loading
the MySQL driver, establishing connection and preparing insert
statements for both kinds of the documents: <code>brewery</code> and <code>beer</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">String schemaRegistryUrl = "http://localhost:8081";
Properties props = new Properties();
props.put(StreamsConfig.APPLICATION_ID_CONFIG, "streams-test");
props.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, "localhost:9092");
props.put(StreamsConfig.ZOOKEEPER_CONNECT_CONFIG, "localhost:2181");
props.put(AbstractKafkaAvroSerDeConfig.SCHEMA_REGISTRY_URL_CONFIG, schemaRegistryUrl);
props.put(StreamsConfig.KEY_SERDE_CLASS_CONFIG, KeyAvroSerde.class);
props.put(StreamsConfig.VALUE_SERDE_CLASS_CONFIG, ValueAvroSerde.class);
props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next block supplies the Streams configuration. Along with endpoints,
it sets serializers and deserializers for keys and values, which appear
in the Kafka topics. These values are written by the Couchbase
connector. Here we use simple classes
<a href="https://github.com/couchbase/kafka-connect-couchbase/blob/master/src/test/java/examples/serde/KeyAvroSerde.java">src/test/java/examples/serde/KeyAvroSerde.java</a>
and
<a href="https://github.com/couchbase/kafka-connect-couchbase/blob/master/src/test/java/examples/serde/ValueAvroSerde.java">src/test/java/examples/serde/ValueAvroSerde.java</a>,
which do not make assumptions about the document body, but the real
application might implement serdes, working with more specific classes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KStreamBuilder builder = new KStreamBuilder();

KStream&lt;String, GenericRecord&gt; source = builder
        .stream("streaming-topic-beer-sample");</code></pre>
</div>
</div>
<div class="paragraph">
<p>We start constructing the source stream by pulling data from the Kafka
topic <code>streaming-topic-beer-sample</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">KStream&lt;String, JsonNode&gt;[] documents = source
        .mapValues(new ValueMapper&lt;GenericRecord, JsonNode&gt;() {
            @Override
            public JsonNode apply(GenericRecord value) {
                ByteBuffer buf = (ByteBuffer) value.get("content");
                try {
                    JsonNode doc = MAPPER.readTree(buf.array());
                    return doc;
                } catch (IOException e) {
                    return null;
                }
            }
        })
        .branch(
                new Predicate&lt;String, JsonNode&gt;() {
                    @Override
                    public boolean test(String key, JsonNode value) {
                        return "beer".equals(value.get("type").asText()) &amp;&amp;
                                value.has("brewery_id") &amp;&amp;
                                value.has("name") &amp;&amp;
                                value.has("description") &amp;&amp;
                                value.has("category") &amp;&amp;
                                value.has("style") &amp;&amp;
                                value.has("abv") &amp;&amp;
                                value.has("ibu") &amp;&amp;
                                value.has("updated");
                    }
                },
                new Predicate&lt;String, JsonNode&gt;() {
                    @Override
                    public boolean test(String key, JsonNode value) {
                        return "brewery".equals(value.get("type").asText()) &amp;&amp;
                                value.has("name") &amp;&amp;
                                value.has("description") &amp;&amp;
                                value.has("country") &amp;&amp;
                                value.has("city") &amp;&amp;
                                value.has("state") &amp;&amp;
                                value.has("phone") &amp;&amp;
                                value.has("updated");
                    }
                }
        );</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first step in our pipeline would be to extract <code>content</code> from the
Couchbase event and deserialize it as JSON, as Couchbase operates with
JSON documents normally, and in <code>beer-sample</code> bucket in particular. With
<code>branch</code> operator, we split stream into two by the document type, and in
the same type we filter out documents that don&#8217;t have all the fields we
want to insert into the MySQL database.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">documents[0].foreach(new ForeachAction&lt;String, JsonNode&gt;() {
    @Override
    public void apply(String key, JsonNode value) {
        try {
            insertBeer.setString(1, key);
            insertBeer.setString(2, value.get("brewery_id").asText());
            insertBeer.setString(3, value.get("name").asText());
            insertBeer.setString(4, value.get("description").asText());
            insertBeer.setString(5, value.get("category").asText());
            insertBeer.setString(6, value.get("style").asText());
            insertBeer.setBigDecimal(7, new BigDecimal(value.get("abv").asText()));
            insertBeer.setBigDecimal(8, new BigDecimal(value.get("ibu").asText()));
            insertBeer.setDate(9, new Date(DATE_FORMAT.parse(value.get("updated").asText()).getTime()));
            insertBeer.execute();
        } catch (SQLException e) {
            System.err.println("Failed to insert record: " + key + ". " + e);
        } catch (ParseException e) {
            System.err.println("Failed to insert record: " + key + ". " + e);
        }
    }
});
documents[1].foreach(new ForeachAction&lt;String, JsonNode&gt;() {
    @Override
    public void apply(String key, JsonNode value) {
        try {
            insertBrewery.setString(1, key);
            insertBrewery.setString(2, value.get("name").asText());
            insertBrewery.setString(3, value.get("description").asText());
            insertBrewery.setString(4, value.get("country").asText());
            insertBrewery.setString(5, value.get("city").asText());
            insertBrewery.setString(6, value.get("state").asText());
            insertBrewery.setString(7, value.get("phone").asText());
            insertBrewery.setDate(8, new Date(DATE_FORMAT.parse(value.get("updated").asText()).getTime()));
            insertBrewery.execute();
        } catch (SQLException e) {
            System.err.println("Failed to insert record: " + key + ". " + e);
        } catch (ParseException e) {
            System.err.println("Failed to insert record: " + key + ". " + e);
        }
    }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the documents are extracted and filtered we are ready to insert
them into the MySQL database using statements prepared earlier. Note
that inserted records are using the document ID from Couchbase, which
means that records will be updated in place automatically without
creating duplicates. This example does not handle document deletions or
expiration, but it won&#8217;t be complex to do with an additional stream that
executes <code>DELETE</code> statements</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">final KafkaStreams streams = new KafkaStreams(builder, props);
streams.start();
Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() {
    @Override
    public void run() {
        streams.close();
    }
}));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last step is to execute the whole pipeline.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running"><a class="anchor" href="#running"></a>Running</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We start by setting up the connector to relay the bucket contents into
the Kafka topic <code>streaming-topic-beer-sample</code>. It could be done either
using property files and <code>connect-standalone</code> as in
<a href="quickstart.html">Quickstart</a>, using REST interface of
<code>connect-distributed</code> or using Web UI provided by Control Center. We
will use the last two options.</p>
</div>
<div class="paragraph">
<p>By default Control Center starts at <code><a href="http://localhost:9021/" class="bare">http://localhost:9021/</a></code>. Connector
configuration is accessible in the "Kafka Connect" section:<br>
<span class="image"><img src="_images/images/kafka3-kafka-connect.png" alt="image" width="570"></span><br></p>
</div>
<div class="paragraph">
<p>Clicking on "New source" will open the configuration page of connectors.
Specify "Connection Name" as <code>sample</code> and "Connection Class" as
<code>CouchbaseSourceConnector</code>. Once the connector class is selected, the UI
will render a list of all accessible configuration properties:<br>
<span class="image"><img src="_images/images/kafka3-setup-source-connector.png" alt="image" width="570"></span><br></p>
</div>
<div class="paragraph">
<p>The "Continue" button will lead to the next step where the form values
are converted into JSON, which can be used to define the connector using
the REST API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ curl -X POST -H "Content-Type: application/json" http://localhost:8083/connectors \
     --data '{
               "name": "sample",
               "connector.class": "com.couchbase.connect.kafka.CouchbaseSourceConnector",
               "tasks.max": 2,
               "connection.cluster_address": "localhost",
               "connection.bucket": "beer-sample",
               "topic.name": "streaming-topic-beer-sample"
             }'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Submitting the form (or using a REST call) will register the new
Connector link and start it immediately.</p>
</div>
<div class="paragraph">
<p>Now lets pull the sample sources and build them:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ git clone git://github.com/couchbase/kafka-connect-couchbase
$ cd kafka-connect-couchbase
$ mvn test-compile
$ java -cp ./target/test-classes:$(mvn dependency:build-classpath | grep ^/) \
       examples.KafkaStreamsDemo</code></pre>
</div>
</div>
<div class="paragraph">
<p>The records will start filling the <code>beers</code> and <code>breweries</code> tables.</p>
</div>
<div class="paragraph">
<p><strong>Parent topic:</strong> <a href="../../connectors/kafka-3.2/kafka-intro.html">Kafka
Connector 3.2</a></p>
</div>
<div class="paragraph">
<p><strong>Previous topic:</strong>
<a href="../../connectors/kafka-3.2/sink-configuration-options.html">Sink
Configuration Options</a></p>
</div>
<div class="paragraph">
<p><strong>Next topic:</strong> <a href="../../connectors/kafka-3.2/release-notes.html">Release
Notes</a></p>
</div>
</div>
</div>
</article>
      <script>
        /* From https://stackoverflow.com/questions/18294759/use-javascript-to-add-a-css-class-to-all-elements-with-another-class-name */
        window.onload = function() {
          var buttons = document.querySelectorAll(".body .anchor"),
            len = buttons !== null ? buttons.length : 0,
            i = 0;
          for(i; i < len; i++) {
            buttons[i].className += " instructions";
          }
        }
      </script>
      <script>
        /* Inline script to remove the h1 heading when the page is rendered on the dev portal.
           Important otherwise it is displayed twice. */
        if (window.location.host === 'www.couchbaseinc.acct.us.onehippo.com' || window.location.host === 'developer.couchbase.com') {
          var heading = document.querySelector('div.body h1');
          heading.style.display = 'none';
        }
      </script>
      <script>
        /* Script to remove leading whitespace in code snippets.
         * Fix found on StackOverflow: https://stackoverflow.com/a/26230865/1908348 */
        [].forEach.call(document.querySelectorAll('code'), function($code) {
          var lines = $code.textContent.split('\n');
          if (lines[0] === '') {
            lines.shift()
          }
          var matches;
          var indentation = (matches = /^[\s\t]+/.exec(lines[0])) !== null ? matches[0] : null;
          if (!!indentation) {
            lines = lines.map(function(line) {
              line = line.replace(indentation, '')
              return line.replace(/\t/g, '    ')
            });
            $code.textContent = lines.join('\n').trim();
          }
        });
      </script>
    </div>
  </main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/highlight.js"></script>
<script>hljs.initHighlighting()</script>
  </body>
</html>
