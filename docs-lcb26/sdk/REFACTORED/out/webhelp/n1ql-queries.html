
<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
<head><meta name="description" content="You can perform Couchbase Query Language (N1QL) queries via the C client library. N1QL queries are performed using a row-based API. This API is similar in spirit to the view API (see Working with view ..."></meta><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><meta name="copyright" content="(C) Copyright 2005"></meta><meta name="DC.rights.owner" content="(C) Copyright 2005"></meta><meta name="DC.Type" content="concept"></meta><meta name="DC.Title" content="Working with N1QL queries"></meta><meta name="abstract" content="You can perform Couchbase Query Language (N1QL) queries via the C client library."></meta><meta name="description" content="You can perform Couchbase Query Language (N1QL) queries via the C client library."></meta><meta name="DC.Relation" scheme="URI" content="querying-toplevel.html"></meta><meta name="DC.Format" content="XHTML"></meta><meta name="DC.Identifier" content="concept_bhv_nhq_44"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/commonltr.css"><!----></link><title>Working with N1QL queries</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></meta><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/css/webhelp_topic.css"><!----></link><link rel="stylesheet" type="text/css" href="oxygen-webhelp/resources/skins/skin.css"><!----></link><script type="text/javascript"><!--
          
          var prefix = "index.html";
          
          --></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-1.8.2.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.cookie.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery-ui.custom.min.js"><!----></script><script type="text/javascript" src="oxygen-webhelp/resources/js/jquery.highlight-3.js"><!----></script><script type="text/javascript" charset="utf-8" src="oxygen-webhelp/resources/js/webhelp_topic.js"><!----></script></head>
<body onload="highlightSearchTerm()" class="frmBody" id="concept_bhv_nhq_44">
<table class="nav"><tbody><tr><td colspan="2"><div id="printlink"><a href="javascript:window.print();" title="Print this page"></a></div><div id="permalink"><a href="#" title="Link to this page"></a></div></td></tr><tr><td width="75%"><a class="navheader_parent_path" href="querying-toplevel.html" title="You can retrieve sets of information from Couchbase Server by using view queries or N1QL queries.">Querying buckets</a></td><td><div class="navheader">
<span class="navparent"><a class="link" href="querying-toplevel.html" title="You can retrieve sets of information from Couchbase Server by using view queries or N1QL queries."><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Querying buckets</span></a></span>  </div></td></tr></tbody></table>

	<h1 class="title topictitle1">Working with N1QL queries</h1>

	
	<div class="body conbody"><p class="shortdesc">You can perform Couchbase Query Language (N1QL) queries via the C client
		library.</p>

        <p class="p">N1QL queries are performed using a row-based API. This API is similar in spirit to the
            view API (see <a class="xref" href="view-queries.html#concept_tvx_nhq_44" title="You can use MapReduce views to create queryable secondary indexes in Couchbase Server.">Working with view queries</a>). The N1QL API is
            available when the <span class="ph filepath">libcouchbase/n1ql.h</span> file is included.</p>

        <p class="p">To execute a N1QL query, first declare your handler. The handler is called once for each
            JSON-encoded row, and then one last time with the <span class="keyword apiname">LCB_RESP_F_FINAL</span>
            bit set in the <samp class="ph codeph">rflags</samp> response member, where any result metadata
            (including errors) is returned. To actually make sense of the row's content, use a JSON
            decoder on the <samp class="ph codeph">row</samp> and <samp class="ph codeph">nrow</samp> buffer/length fields.</p>

        <div style="margin-bottom: 0;"><strong>N1QL Row Handler</strong></div><pre class="pre codeblock language-c"><strong class="hl-keyword" style="color:#7f0055">static</strong> <strong class="hl-keyword" style="color:#7f0055">void</strong> rowCallback(lcb_t instance, <strong class="hl-keyword" style="color:#7f0055">int</strong> cbtype, <strong class="hl-keyword" style="color:#7f0055">const</strong> lcb_RESPN1QL *resp) {
    <strong class="hl-keyword" style="color:#7f0055">if</strong> (! (resp-&gt;rflags &amp; LCB_RESP_F_FINAL)) {
        printf(<span class="hl-string" style="color:#2a00ff">"Row: %.*s\n"</span>, (<strong class="hl-keyword" style="color:#7f0055">int</strong>)resp-&gt;nrow, resp-&gt;row);
    } <strong class="hl-keyword" style="color:#7f0055">else</strong> {
        printf(<span class="hl-string" style="color:#2a00ff">"Got metadata: %.*s\n"</span>, (<strong class="hl-keyword" style="color:#7f0055">int</strong>)resp-&gt;nrow, resp-&gt;row);
    }
}</pre>

        <p class="p">To issue the actual query, populate an <samp class="ph codeph">lcb_CMDN1QL</samp> structure with
            appropriate parameters. Some of the internals of this structure may be populated using
            the <samp class="ph codeph">lcb_N1QLPARAMS</samp> object. The <samp class="ph codeph">lcb_N1QLPARAMS</samp> object
            is provided as a higher-level means by which to construct N1QL queries and supports N1QL
            features such as query placeholders and prepared statements. For example, to issue a
            query with a placeholder:</p>

        <ol class="ol" id="concept_bhv_nhq_44__ol_hbm_zm3_kr">
            <li class="li">Create the <samp class="ph codeph">params</samp> object (<span class="keyword apiname">lcb_n1p_new()</span>).</li>

            <li class="li">Set the query string (<samp class="ph codeph">lcb_n1p_setstmtz(params,
                "statement_string")</samp>).</li>

            <li class="li">Set the placeholders (<samp class="ph codeph">lcb_n1p_namedparamz(params, "$param1", "value1");
                    lcb_n1p_namedparamz(params, "$param2", "value2")</samp>).</li>

            <li class="li">Populate the <span class="keyword apiname">lcb_CMDN1QL</span> structure with the encoded query
                    (<samp class="ph codeph">lcb_n1p_mkcmd(params, &amp;cmd)</samp>).</li>

            <li class="li">Issue the query (<span class="keyword apiname">lcb_n1ql_query</span>).</li>

            <li class="li">(Optional): You can dump the encoded form of the query using the return value from
					<span class="keyword apiname">lcb_n1p_encode()</span>. This returns a null-terminated string.</li>

            <li class="li">Free or clear the <samp class="ph codeph">params</samp> object (<span class="keyword apiname">lcb_n1p_free</span> or
                    <span class="keyword apiname">lcb_n1p_reset</span>).</li>

        </ol>

        <p class="p">Here's a code example that uses named parameters:</p>

        <div style="margin-bottom: 0;"><strong>Issuing a N1QL query with a placeholder</strong></div><pre class="pre codeblock language-c"><em class="hl-comment" style="color:#006400">// Error checking omitted for brevity</em>

<em class="hl-comment" style="color:#006400">// The command structure</em>
lcb_CMDN1QL cmd = { <span class="hl-number">0</span> };
<em class="hl-comment" style="color:#006400">// Allocate the parameter object</em>
lcb_N1QLPARAMS *nparams = lcb_n1p_new();

lcb_n1p_setstmtz(nparams,
   <span class="hl-string" style="color:#2a00ff">"SELECT fname || \" \" || lname, age FROM default WHERE age &gt; $age LIMIT 5"</span>);
<em class="hl-comment" style="color:#006400">// Set the value for '$age'</em>
lcb_n1p_namedparamz(nparams, <span class="hl-string" style="color:#2a00ff">"$age"</span>, <span class="hl-string" style="color:#2a00ff">"27"</span>);
<em class="hl-comment" style="color:#006400">// Now, fill the command structure</em>
lcb_n1p_mkcmd(nparams, &amp;cmd);
<span class="hl-directive" style="color:#8b26c9">#if DEBUG</span>
<em class="hl-comment" style="color:#006400">// Dump the encoded query</em>
printf(<span class="hl-string" style="color:#2a00ff">"Encoded query is: %s\n"</span>, lcb_n1p_encode(nparams));
<span class="hl-directive" style="color:#8b26c9">#endif</span>
cmd.callback = rowCallback;

lcb_error_t rc = lcb_n1ql_query(instance, NULL, &amp;cmd);
<strong class="hl-keyword" style="color:#7f0055">if</strong> (rc != LCB_SUCCESS) {
    <em class="hl-comment" style="color:#006400">// OOPS!</em>
}
<em class="hl-comment" style="color:#006400">// We can release the params object now..</em>
lcb_n1p_free(nparams);
lcb_wait(instance);
</pre>

        <div class="p">You can also utilize the encoded query directly (without using
                <span class="keyword apiname">lcb_N1QLPARAMS</span>). This involves using a pre-encoded query per the
            N1QL REST API. This example issues the same query as above, bypassing the parameters
            object, and encoding the query
            manually.<div style="margin-bottom: 0;"><strong>User-encoded query</strong></div><pre class="pre codeblock language-c"><strong class="hl-keyword" style="color:#7f0055">const</strong> <strong class="hl-keyword" style="color:#7f0055">char</strong> *querystr = 
    <span class="hl-string" style="color:#2a00ff">"{"</span>
        <em class="hl-comment" style="color:#006400">/* read as SELECT fname || " " || lname FROM default WHERE age &gt; $age LIMIT 5 */</em>
        <span class="hl-string" style="color:#2a00ff">"\"statement\":"</span>SELECT fname || \<span class="hl-string" style="color:#2a00ff">" \" || lname, age FROM default WHERE age &gt; $age LIMIT 5\","</span>
        <span class="hl-string" style="color:#2a00ff">"\"$age\": 27"</span>
    <span class="hl-string" style="color:#2a00ff">"}"</span>
lcb_CMDN1QL cmd = { <span class="hl-number">0</span> };
cmd.query = querystr;
cmd.nquery = strlen(querystr);
cmd.callback = rowCallback;
lcb_error_t rc = lcb_n1ql_query(instance, NULL, &amp;cmd);
<em class="hl-comment" style="color:#006400">// ...</em></pre>
</div>

        <div class="p">
            <div class="note note"><span class="notetitle">Note:</span> Versions prior to 2.5.3 require the <samp class="ph codeph">content_type</samp> field to be set
                to <samp class="ph codeph">application/json</samp>. Since version 2.5.3, all queries must be in
                JSON, and the <samp class="ph codeph">content_type</samp> field is ignored.</div>

        </div>

        <div class="section"><h2 class="title sectiontitle">Prepared Statements</h2>Since version 2.5.3, applications may optimize
            frequently issued statements by having the client internally <em class="ph i">prepare</em> them. To use
            prepared statements, simply set the <samp class="ph codeph">LCB_CMDN1QL_F_PREPCACHE</samp> bit in the
                <var class="keyword varname">cmdflags</var>
            field<pre class="pre codeblock">lcb_CMDN1QL cmd = { 0 };
// initialize other sections
cmd.cmdflags |= LCB_CMDN1QL_F_PREPCACHE;</pre>
</div>

    </div>

<div class="related-links"></div>
<div class="navfooter"><!---->
<span class="navparent"><a class="link" href="querying-toplevel.html" title="You can retrieve sets of information from Couchbase Server by using view queries or N1QL queries."><span class="navheader_label">Parent topic</span><span class="navheader_separator">: </span><span class="navheader_linktext">Querying buckets</span></a></span>  </div><div class="footer">WebHelp output generated by<a href="http://www.oxygenxml.com" target="_blank"><span class="oXygenLogo"><img src="oxygen-webhelp/resources/img/LogoOxygen100x22.png" alt="Oxygen"></img></span><span class="xmlauthor">XML Author</span></a> - Trial Edition</div>
</body>
</html>